<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>sandwich: Robust Covariance Matrix Estimators • sandwich</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="sandwich: Robust Covariance Matrix Estimators">
<meta property="og:description" content="sandwich">
<meta property="og:image" content="http://sandwich.R-Forge.R-project.org/logo.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@AchimZeileis">
<meta name="twitter:site" content="@AchimZeileis">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sandwich</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.0-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/sandwich.html">Get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/jss_2004.html">Econometric Computing with HC and HAC Covariance Matrix Estimators</a>
    </li>
    <li>
      <a href="../articles/jss_2006.html">Object-Oriented Computation of Sandwich Estimators</a>
    </li>
    <li>
      <a href="../articles/jss_2020.html">Various Versatile Variances: An Object-Oriented Implementation of Clustered Covariances in R</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li>
  <a href="../contact.html">Contact</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>sandwich: Robust Covariance Matrix Estimators</h1>
                        <h4 class="author">Achim Zeileis, Thomas Lumley, Susanne Berger, Nathaniel Graham</h4>
            
      
      
      <div class="hidden name"><code>sandwich.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>The <a href="https://CRAN.R-project.org/package=sandwich"><strong>sandwich</strong></a> package is designed for obtaining covariance matrix estimators of parameter estimates in statistical models where certain model assumptions have been violated. More specifically, the estimators are useful in a situation where the model’s score function was correctly specified (e.g., the mean function in a linear regression model) but that the remaining likelihood was potentially misspecified (e.g., due to heteroscedasticity or a lack of independence). In this case, the usual parameter estimates are still consistent but the associated covariance matrix estimate is not, thus potentially biasing the inference such as parameter tests or confidence intervals. Luckily, there are covariance matrix estimators that are consistent under these misspecifications and that can simply be plugged in to the usual inference based on the central limit theorem. Because the covariance matrix estimators are a product of two outer “bread” matrices (based on the Hessian of the log-likelihood) and an innter “meat” matrix (based on cross-products of the corresponding score function), they are also known as “sandwich” covariances.</p>
<p>The <em>sandwich</em> package provides a wide range of such sandwich covariances in an object-oriented framework. This means that it takes the models fitted by another package without any modification or adjustment, extracts certain quantities from them, and computes the different covariance matrices based on these. For <em>sandwich</em> to work the model class has to provide at least an <code><a href="../reference/estfun.html">estfun()</a></code> method for extracting the score matrix (containing the gradient contributions per observation) and a <code><a href="../reference/bread.html">bread()</a></code> method for extracting the inverse of some estimate of the Fisher information (that most of the “usual” covariances are based on). Some sandwich covariances also need further methods, e.g., <code><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix()</a></code> or <code><a href="https://rdrr.io/r/stats/influence.measures.html">hatvalues()</a></code> etc. The covariances provided are:</p>
<ul>
<li>Basic <code><a href="../reference/sandwich.html">sandwich()</a></code> for cross-section data.</li>
<li>
<code><a href="../reference/vcovHC.html">vcovHC()</a></code> for heteroscedasticity-consistent (HC) covariances in (generalized) linear models.</li>
<li>
<code><a href="../reference/vcovHAC.html">vcovHAC()</a></code> for heteroscedastiticy- and autocorrelation-consistent (HAC) covariances in time series data with convenience interfaces <code><a href="../reference/weightsAndrews.html">kernHAC()</a></code> (Andrews’ kernel HAC estimator) and <code><a href="../reference/NeweyWest.html">NeweyWest()</a></code>.</li>
<li>
<code><a href="../reference/vcovCL.html">vcovCL()</a></code> for clustered covariances (including multiway clustering).</li>
<li>
<code><a href="../reference/vcovPL.html">vcovPL()</a></code> and <code><a href="../reference/vcovPC.html">vcovPC()</a></code> for panel and panel-corrected covariances.</li>
<li>
<code><a href="../reference/vcovOPG.html">vcovOPG()</a></code> for outer-product-of-gradients covariances.</li>
<li>
<code><a href="../reference/vcovBS.html">vcovBS()</a></code> for bootstrap covariances (with default method and dedicated fast and more flexible methods for <code>lm</code> and <code>glm</code> objects).</li>
</ul>
<p>These can be applied to many different model classes, including <code>lm</code>, <code>glm</code>, <code>survreg</code>, <code>coxph</code>, <code>mlogit</code>, <code>polr</code>, <code>hurdle</code>, <code>zeroinfl</code>, <code>ivreg</code>, <code>betareg</code>, and many more. (There are some exceptions, though, not all covariances are applicable to all models).</p>
<p>The resulting covariances can be subsequently plugged in to various functions for Wald-type inference, including <code><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest()</a></code>, <code><a href="https://rdrr.io/pkg/lmtest/man/waldtest.html">waldtest()</a></code>, and <code><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coefci()</a></code> from the <a href="https://CRAN.R-project.org/package=lmtest"><strong>lmtest</strong></a> package or <code>Anova()</code>, <code>Confint()</code>, <code>S()</code>, <code>linearHypothesis()</code>, and <code>deltaMethod()</code> from <a href="https://CRAN.R-project.org/package=car"><strong>car</strong></a> package.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>The stable release version of <em>sandwich</em> is hosted on the Comprehensive R Archive Network (CRAN) at <a href="https://CRAN.R-project.org/package=sandwich" class="uri">https://CRAN.R-project.org/package=sandwich</a> and can be installed via</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"sandwich"</span>)
</pre></div>
<p>The development version of <em>sandwich</em> is hosted on R-Forge at <a href="https://R-Forge.R-project.org/projects/sandwich/" class="uri">https://R-Forge.R-project.org/projects/sandwich/</a> in a Subversion (SVN) repository. It can be installed via</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"sandwich"</span>, repos = <span class="st">"http://R-Forge.R-project.org"</span>)
</pre></div>
</div>
<div id="publications" class="section level2">
<h2 class="hasAnchor">
<a href="#publications" class="anchor"></a>Publications</h2>
<p>The package development was accompanied by three publications in the <em>Journal of Statistical Software</em>, describing the initial HC and HAC implementation for linear models, the corresponding object-oriented extension, and the generalization to clustered and panel covariances, respectively.</p>
<ul>
<li>Zeileis A (2004). “Econometric Computing with HC and HAC Covariance Matrix Estimators.” <em>Journal of Statistical Software</em>, <strong>11</strong>(10), 1-17. <a href="https://doi.org/10.18637/jss.v011.i10">doi:10.18637/jss.v011.i10</a>.</li>
<li>Zeileis A (2006). “Object-Oriented Computation of Sandwich Estimators.” <em>Journal of Statistical Software</em>, <strong>16</strong>(9), 1-16. <a href="https://doi.org/10.18637/jss.v016.i09">doi:10.18637/jss.v016.i09</a>.</li>
<li>Berger S, Graham N, Zeileis A (2020). “Various Versatile Variances: An Object-Oriented Implementation of Clustered Covariances in R.” <em>Journal of Statistical Software</em>, <strong>95</strong>(1), 1-36. <a href="https://doi.org/10.18637/jss.v095.i01">doi:10.18637/jss.v095.i01</a>.</li>
</ul>
</div>
<div id="illustrations" class="section level2">
<h2 class="hasAnchor">
<a href="#illustrations" class="anchor"></a>Illustrations</h2>
<p>To illustrate the functionality of the <code>sandwich</code> package we employ a well-known data set that was created by Petersen for benchmarking clustered standard errors. However, because the data is so simple, we will use it here to illustrate all sorts of covariances (not only clustered ones).</p>
<p>The data come from a simple linear regression of a response <code>y</code> on an explanatory variable <code>x</code>, but the data are clustered by <code>firm</code> (500 firms) and <code>year</code> (10 years). The data can be loaded and the model fitted by ordinary least squares (OLS):</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"PetersenCL"</span>, package = <span class="st">"sandwich"</span>)
<span class="kw">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="kw">y</span> <span class="op">~</span> <span class="kw">x</span>, data = <span class="kw">PetersenCL</span>)
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw">m</span>)
</pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ x, data = PetersenCL)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -6.761 -1.368 -0.017  1.339  8.678 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   0.0297     0.0284    1.05      0.3    
## x             1.0348     0.0286   36.20   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 2.01 on 4998 degrees of freedom
## Multiple R-squared:  0.208,  Adjusted R-squared:  0.208 
## F-statistic: 1.31e+03 on 1 and 4998 DF,  p-value: &lt;2e-16</code></pre>
<p>The regression summary for a linear model uses the “usual” OLS standard errors, assuming that the data are uncorrelated and homoscedastic. The summary provides partial Wald tests for the regression coefficients and also an over <em>F</em> test assessing all the regressors, i.e., in this case equivalent to a <em>t</em> test of <code>x</code>. To obtain the analogous tests and corresponding confidence intervals using the basic “robust” sandwich covariance for cross-section data we can combine <em>sandwich</em> with the <em>lmtest</em> package:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st"><a href="http://sandwich.R-Forge.R-project.org">"sandwich"</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"lmtest"</span>)
<span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span>(<span class="kw">m</span>, vcov = <span class="kw">sandwich</span>)
</pre></div>
<pre><code>## 
## t test of coefficients:
## 
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   0.0297     0.0284    1.05      0.3    
## x             1.0348     0.0284   36.45   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coefci</a></span>(<span class="kw">m</span>, vcov = <span class="kw">sandwich</span>)
</pre></div>
<pre><code>##               2.5 % 97.5 %
## (Intercept) -0.0259 0.0853
## x            0.9792 1.0905</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">m0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="kw">y</span> <span class="op">~</span> <span class="fl">1</span>, data = <span class="kw">PetersenCL</span>)
<span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/waldtest.html">waldtest</a></span>(<span class="kw">m0</span>, <span class="kw">m</span>, vcov = <span class="kw">sandwich</span>)
</pre></div>
<pre><code>## Wald test
## 
## Model 1: y ~ 1
## Model 2: y ~ x
##   Res.Df Df    F Pr(&gt;F)    
## 1   4999                   
## 2   4998  1 1329 &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
<p>Other covariances can be plugged in analogously, potentially passing along further options for the covariance. For example, the clustered covariance <code><a href="../reference/vcovCL.html">vcovCL()</a></code> can be used with the clustering variable <code>firm</code> as:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span>(<span class="kw">m</span>, vcov = <span class="kw">vcovCL</span>, cluster = <span class="op">~</span> <span class="kw">firm</span>)
</pre></div>
<pre><code>## 
## t test of coefficients:
## 
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   0.0297     0.0670    0.44     0.66    
## x             1.0348     0.0506   20.45   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
<p>In the same way we can compute and compare many of the other estimators in the package. A selection, mostly just with the default settings, is provided here. First, the covarainces are computed and then the corresponding standard errors extracted (square root of the diagonal):</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">vc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="st">"Standard"</span>              = <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html">vcov</a></span>(<span class="kw">m</span>),
  <span class="st">"Sandwich (basic)"</span>      = <span class="fu"><a href="../reference/sandwich.html">sandwich</a></span>(<span class="kw">m</span>),
  <span class="st">"Clustered"</span>             = <span class="fu"><a href="../reference/vcovCL.html">vcovCL</a></span>(<span class="kw">m</span>, cluster = <span class="op">~</span> <span class="kw">firm</span>),
  <span class="st">"Clustered (two-way)"</span>   = <span class="fu"><a href="../reference/vcovCL.html">vcovCL</a></span>(<span class="kw">m</span>, cluster = <span class="op">~</span> <span class="kw">firm</span> <span class="op">+</span> <span class="kw">year</span>),
  <span class="st">"HC3"</span>                   = <span class="fu"><a href="../reference/vcovHC.html">vcovHC</a></span>(<span class="kw">m</span>),
  <span class="st">"Andrews' kernel HAC"</span>   = <span class="fu"><a href="../reference/weightsAndrews.html">kernHAC</a></span>(<span class="kw">m</span>),
  <span class="st">"Newey-West"</span>            = <span class="fu"><a href="../reference/NeweyWest.html">NeweyWest</a></span>(<span class="kw">m</span>),
  <span class="st">"Bootstrap"</span>             = <span class="fu"><a href="../reference/vcovBS.html">vcovBS</a></span>(<span class="kw">m</span>),
  <span class="st">"Bootstrap (clustered)"</span> = <span class="fu"><a href="../reference/vcovBS.html">vcovBS</a></span>(<span class="kw">m</span>, cluster = <span class="op">~</span> <span class="kw">firm</span>)
)
<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="kw">vc</span>, <span class="fu">function</span>(<span class="kw">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="kw">x</span>))))
</pre></div>
<pre><code>##                       (Intercept)      x
## Standard                   0.0284 0.0286
## Sandwich (basic)           0.0284 0.0284
## Clustered                  0.0670 0.0506
## Clustered (two-way)        0.0651 0.0536
## HC3                        0.0284 0.0284
## Andrews' kernel HAC        0.0437 0.0351
## Newey-West                 0.0660 0.0482
## Bootstrap                  0.0280 0.0311
## Bootstrap (clustered)      0.0655 0.0496</code></pre>
<p>This shows that due to the cluster-correlation in the data, the usual standard errors and cross-section covariances are much too small. In contrast, the different types of clustered standard errors are much larger and more appropriate here.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Achim Zeileis, Thomas Lumley.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
